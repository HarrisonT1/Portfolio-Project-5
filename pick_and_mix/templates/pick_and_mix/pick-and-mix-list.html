{% extends "base.html" %} {% load static %}

{% block content %}
    <div class="side-bar-filters ms-3 container">
        <div class="row">
            <div class="col-12 text-center mt-5">
                {% if not pick_and_mix %}
                    Your pick and mix bag currently has {{ max_weight }} grams left
                {% else %}
                    Your pick and mix bag currently has {{ remaining_weight }} grams left
                {% endif %}
                <form method="POST" action="{% url 'pick_and_mix_add_basket' pnmbag.slug %}">
                    {% csrf_token %}
                    <button type="submit" class="btn button-effect">Send pick and mix bag to checkout</button>
                </form>
            </div>
            <div class="col-md-3 mt-5">
                <form method="GET">
                    <h3>Filters</h3>
                    {% for category in categories %}
                        <div class="form-check">
                            <input type="checkbox" id="category-{{ category.id }}" value="{{ category.slug }}" name="category" {% if category.slug in selected_category %}checked{% endif %}>
                            <label for="category-{{ category.id }}">{{ category.name }}</label>
                        </div>
                    {% endfor %}
                    <h3>Dietary Needs</h3>
                    {% for tag in dietary_tags %}
                        <div class="form-check">
                            <input type="checkbox" id="tag-{{ tag.id }}" value="{{ tag.slug }}" name="dietary_tag" {% if tag.slug in selected_dietary_tags %}checked{% endif %}>
                            <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                        </div>
                    {% endfor %}
                    <button type="submit" class="btn button-effect">Filter Results</button>
                </form>
            </div>
            <div class="col-md-9 row justify-content-center mt-5">
                {% for product in products %}
                    <div class="col-12 col-md-6 col-lg-4 d-flex justify-content-center mt-3">
                        <div class="card">
                            <img src="{{ product.image.url }}" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">{{ product.description }}</p>
                            </div>
                            <strong class="text-center">{{ product.sweet_category.weight_in_grams }}g per item</strong>
                            <form data-weight="{{ product.sweet_category.weight_in_grams }}" class="add-grams-form text-center" method="POST" action="{% url 'pick_and_mix_add' pnmbag.slug product.slug %}">
                                {% csrf_token %}
                                <input class="quantity-input" class="text-center d-block mx-auto w-25" type="number" name="quantity" value="1" min="1" max="400">
                                <button type="submit" class="btn button-effect">Add</button>
                                <p>Total product weight: <span class="total-weight"></span>g</p>
                            </form>
                        </div>
                    </div>    
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}


{% block extra_js %}
    {{ block.super }}
    <script type="text/javascript">
        $(function () {
            $(".add-grams-form").each(function() {
                var $form = $(this)
                var $input = $form.find('.quantity-input')
                var $totalDisplay = $form.find('.total-weight')
                var weightPerItem = parseFloat($form.attr("data-weight"))
        
                function updateWeight() {
                    var quantity = parseInt($input.val()) || 0;
                    var totalWeight = quantity * weightPerItem
                    $totalDisplay.text(totalWeight)
                }
                updateWeight();
        
                $input.on("input", function() {
                    updateWeight()
                })
            })
        })
    </script>
{% endblock %}